<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>TON Vesting Contracts - Validators Dashboard</title>
    <link rel="stylesheet" href="assets/validators.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h1>TON Vesting Contracts</h1>
        <div class="subtitle">All Vesting contracts with sorting functionality</div>
        <div class="nav-buttons">
            <a href="index.html" class="nav-button">
                ğŸ  Validators
            </a>
            <a href="nominators.html" class="nav-button">
                ğŸ“Š Nominators
            </a>
            <a href="vesting.html" class="nav-button active">
                ğŸ’° Vesting
            </a>
            <a href="tontech.html" class="nav-button">
                ğŸ”¬ TON Data
            </a>
            <a href="ktonviewer.html" class="nav-button">
                ğŸ” LST Tool
            </a>
        </div>
    </div>

    <div id="statsContainer" class="stats-grid">
    </div>



    <div id="tableContainer">
    </div>
</div>



<div class="api-status" id="apiStatus">
    <div>Data Source: <span class="api-name" id="apiName">Tonscan API</span></div>
    <div class="api-performance" id="apiPerformance"></div>
</div>

<script>
    // å·¥å…·å‡½æ•¸
    const fromNano = (nano) => {
        return BigInt(nano) / BigInt(1e9);
    }

    const toMillions = (n) => {
        return (Number(n) / 1e6).toFixed(3) + 'M';
    }

    const toMillionsShort = (n) => {
        let s = (Number(n) / 1e6).toFixed(3);
        for (let i = 0; i < 3; i++) {
            if (s.endsWith('0')) s = s.substring(0, s.length - 1);
        }
        if (s.endsWith('.')) s = s.substring(0, s.length - 1);
        return s + 'M';
    }

    const withCommas = (n) => {
        try {
            const num = typeof n === 'bigint' ? Number(n) : Number(n);
            if (Number.isNaN(num)) return n;
            return num.toLocaleString('en-US');
        } catch {
            return n;
        }
    }

    const makeAddressUrl = (address) => {
        return `<a href="https://tonscan.org/address/${address}" target="_blank">${address}</a>`;
    }

    const showLoading = () => {
        // è¼‰å…¥æŒ‡ç¤ºå™¨å·²ç§»é™¤ï¼Œç„¡éœ€é¡¯ç¤º
    }

    const hideLoading = () => {
        // è¼‰å…¥æŒ‡ç¤ºå™¨å·²ç§»é™¤ï¼Œç„¡éœ€éš±è—
    }

    const updateProgress = (percentage, text = null) => {
        // é€²åº¦æ›´æ–°å·²ç§»é™¤ï¼Œåƒ…ä¿ç•™ console.log ç”¨æ–¼èª¿è©¦
        if (text) {
            console.log(`è¼‰å…¥é€²åº¦: ${Math.round(percentage)}% - ${text}`);
        }
    }

    const timestampToDate = (timestamp) => {
        const date = new Date(timestamp * 1000);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // å…¨åŸŸè®Šæ•¸
    let vestingData = [];
    let filteredData = [];
    let sortColumn = 'balance'; // é è¨­æŒ‰é¤˜é¡æ’åº
    let sortDirection = 'desc'; // é è¨­é™åº

    // API ç‹€æ…‹æ›´æ–°
    function updateApiStatus(apiName, responseTime = null) {
        const apiStatus = document.getElementById('apiStatus');
        const apiNameElement = document.getElementById('apiName');
        const apiPerformance = document.getElementById('apiPerformance');

        apiNameElement.textContent = apiName;
        
        let performanceText = '';
        if (responseTime !== null) {
            performanceText = `${responseTime.toFixed(0)}ms`;
        }
        
        apiPerformance.textContent = performanceText;
        apiStatus.classList.add('show');
        
        setTimeout(() => {
            apiStatus.classList.remove('show');
        }, 3000);
    }

    // ç²å–æ‰€æœ‰ Vesting åˆç´„åœ°å€
    async function fetchAllVestingAddresses() {
        const CODE_HASH = 'tItTGr7DtxRjgpH3137W3J9qJynvyiBHcTc3TUrotZA=';
        const BATCH_SIZE = 50;
        let allAddresses = [];
        let offset = 0;
        let hasMore = true;
        const maxEstimated = 500; // é ä¼°æœ€å¤§æ•¸é‡ç”¨æ–¼é€²åº¦è¨ˆç®—

        updateProgress(10, 'Fetching Vesting contract list...');

        while (hasMore && allAddresses.length < 500) {
            try {
                const url = `https://api.tonscan.com/api/bt/getAddressesForContract?code_hash=${encodeURIComponent(CODE_HASH)}&limit=${BATCH_SIZE}&offset=${offset}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æª¢æŸ¥ API éŸ¿æ‡‰çµæ§‹
                if (!data.json || !data.json.data) {
                    console.warn('API éŸ¿æ‡‰æ ¼å¼ç•°å¸¸:', data);
                    hasMore = false;
                    break;
                }
                
                const addresses = data.json.data;
                
                if (!Array.isArray(addresses) || addresses.length === 0) {
                    console.log(`åœ¨ offset ${offset} è™•ç„¡æ›´å¤šæ•¸æ“šï¼ŒçµæŸç²å–`);
                    hasMore = false;
                } else {
                    allAddresses = allAddresses.concat(addresses);
                    offset += BATCH_SIZE;
                    
                    // æ›´æ–°é€²åº¦ (10% - 70%)
                    const fetchProgress = Math.min(70, 10 + (allAddresses.length / maxEstimated) * 60);
                    updateProgress(fetchProgress, `å·²ç²å– ${allAddresses.length} å€‹ Vesting åˆç´„åœ°å€...`);
                    
                    console.log(`å·²ç²å– ${allAddresses.length} å€‹ Vesting åˆç´„åœ°å€...`);
                }
                
                // é¿å…è«‹æ±‚éæ–¼é »ç¹
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error(`ç²å–åœ°å€åˆ—è¡¨å¤±æ•— (offset: ${offset}):`, error);
                hasMore = false;
                break;
            }
        }

        updateProgress(80, 'æ­£åœ¨è™•ç†å’Œæ’åºæ•¸æ“š...');
        console.log(`ç¸½å…±ç²å– ${allAddresses.length} å€‹ Vesting åˆç´„åœ°å€`);

        // éæ¿¾ç„¡æ•ˆæ•¸æ“šä¸¦æŒ‰é¤˜é¡æ’åº
        const validAddresses = allAddresses.filter(addr => 
            addr && addr.address && typeof addr.balance !== 'undefined'
        );
        
        updateProgress(90, 'æ­£åœ¨æ’åºåˆç´„...');
        
        validAddresses.sort((a, b) => {
            try {
                return BigInt(b.balance) - BigInt(a.balance) > 0 ? 1 : -1;
            } catch (e) {
                console.warn('æ’åºæ™‚é‡åˆ°ç„¡æ•ˆé¤˜é¡:', a.balance, b.balance);
                return 0;
            }
        });
        
        updateProgress(100, 'è¼‰å…¥å®Œæˆï¼');
        
        return validAddresses; // è¿”å›æ‰€æœ‰åœ°å€ï¼Œä¸é™åˆ¶æ•¸é‡
    }

    // æ¸²æŸ“çµ±è¨ˆè³‡æ–™
    function renderStats() {
        if (!vestingData || vestingData.length === 0) {
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <h3>Loading...</h3>
                    <p class="value">-</p>
                </div>
            `;
            return;
        }

        const totalContracts = vestingData.length;
        const totalBalance = vestingData.reduce((sum, contract) => {
            try {
                return sum + BigInt(contract.balance || 0);
            } catch (e) {
                console.warn('ç„¡æ•ˆçš„é¤˜é¡æ•¸æ“š:', contract.balance);
                return sum;
            }
        }, BigInt(0));
        
        const activeContracts = vestingData.filter(c => c.balance && Number(c.balance) > 0).length;
        const averageBalance = totalContracts > 0 ? totalBalance / BigInt(totalContracts) : BigInt(0);

        const oldestContract = vestingData.reduce((oldest, contract) => {
            if (!contract.created_utime) return oldest;
            if (!oldest.created_utime) return contract;
            return contract.created_utime < oldest.created_utime ? contract : oldest;
        }, {created_utime: Date.now() / 1000});

        document.getElementById('statsContainer').innerHTML = `
            <div class="stat-card">
                <h3>Total Contracts</h3>
                <p class="value">${withCommas(totalContracts)}</p>
            </div>
            <div class="stat-card">
                <h3>Active Contracts</h3>
                <p class="value">${withCommas(activeContracts)}</p>
            </div>
            <div class="stat-card">
                <h3>Total Balance</h3>
                <p class="value">${toMillionsShort(fromNano(totalBalance))} TON</p>
            </div>
            <div class="stat-card">
                <h3>Average Balance</h3>
                <p class="value">${toMillionsShort(fromNano(averageBalance))} TON</p>
            </div>
            <div class="stat-card">
                <h3>Oldest Contract</h3>
                <p class="value">${oldestContract.created_utime ? new Date(oldestContract.created_utime * 1000).toLocaleDateString() : 'N/A'}</p>
            </div>
        `;
    }

    // æ’åºå‡½æ•¸
    function sortData(column) {
        if (sortColumn === column) {
            // å¦‚æœé»æ“ŠåŒä¸€åˆ—ï¼Œå‰‡åˆ‡æ›æ’åºæ–¹å‘
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // å¦‚æœé»æ“Šä¸åŒåˆ—ï¼Œå‰‡è¨­ç‚ºæ–°åˆ—ä¸¦ä½¿ç”¨é è¨­æ’åºæ–¹å‘
            sortColumn = column;
            sortDirection = column === 'balance' ? 'desc' : 'asc';
        }
        
        filterData();
    }

    // æ’åºæ•¸æ“š
    function filterData() {
        let filtered = [...vestingData]; // è¤‡è£½æ‰€æœ‰æ•¸æ“š

        // æ’åºé‚è¼¯
        filtered.sort((a, b) => {
            let valueA, valueB;
            
            switch (sortColumn) {
                case 'rank':
                    valueA = vestingData.indexOf(a) + 1;
                    valueB = vestingData.indexOf(b) + 1;
                    break;
                case 'address':
                    valueA = a.address.toLowerCase();
                    valueB = b.address.toLowerCase();
                    break;
                case 'balance':
                    valueA = BigInt(a.balance || 0);
                    valueB = BigInt(b.balance || 0);
                    break;
                case 'created':
                    valueA = a.created_utime || 0;
                    valueB = b.created_utime || 0;
                    break;
                case 'lastTx':
                    valueA = a.latest_transaction_time || 0;
                    valueB = b.latest_transaction_time || 0;
                    break;
                default:
                    return 0;
            }
            
            if (sortColumn === 'balance') {
                // BigInt æ¯”è¼ƒ
                const result = valueA - valueB;
                return sortDirection === 'asc' ? 
                    (result > 0 ? 1 : result < 0 ? -1 : 0) : 
                    (result > 0 ? -1 : result < 0 ? 1 : 0);
            } else {
                // ä¸€èˆ¬æ¯”è¼ƒ
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            }
        });

        filteredData = filtered;
        renderTable();
    }

    // ç²å–æ’åºåœ–æ¨™
    function getSortIcon(column) {
        if (sortColumn !== column) {
            return '<span class="sort-icon">â†•ï¸</span>';
        }
        return sortDirection === 'asc' ? 
            '<span class="sort-icon active">â†‘</span>' : 
            '<span class="sort-icon active">â†“</span>';
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const container = document.getElementById('tableContainer');
        
        // æ¡Œé¢ç‰ˆè¡¨æ ¼
        let desktopHtml = `
            <table>
                <thead>
                    <tr>
                        <th onclick="sortData('rank')">
                            Rank ${getSortIcon('rank')}
                        </th>
                        <th onclick="sortData('address')">
                            Address ${getSortIcon('address')}
                        </th>
                        <th onclick="sortData('balance')">
                            Balance (TON) ${getSortIcon('balance')}
                        </th>
                        <th onclick="sortData('created')">
                            Created ${getSortIcon('created')}
                        </th>
                        <th onclick="sortData('lastTx')">
                            Last Transaction ${getSortIcon('lastTx')}
                        </th>
                    </tr>
                </thead>
                <tbody>
        `;

        // æ‰‹æ©Ÿç‰ˆå¡ç‰‡
        let mobileHtml = '<div class="mobile-table">';

        filteredData.forEach((contract, index) => {
            const balance = fromNano(contract.balance);
            const balanceDisplay = Number(balance) === 0 ? '0' : toMillions(balance);
            const rank = vestingData.indexOf(contract) + 1;
            
            // æ¡Œé¢ç‰ˆè¡¨æ ¼è¡Œ
            desktopHtml += `
                <tr>
                    <td><span class="badge badge-info">#${rank}</span></td>
                    <td class="mono">${makeAddressUrl(contract.address)}</td>
                    <td><strong>${balanceDisplay} TON</strong></td>
                    <td>${timestampToDate(contract.created_utime)}</td>
                    <td>${timestampToDate(contract.latest_transaction_time)}</td>
                </tr>
            `;

            // æ‰‹æ©Ÿç‰ˆå¡ç‰‡
            mobileHtml += `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <div class="mobile-card-title">
                            Vesting Contract #${rank}
                        </div>
                        <div class="mobile-card-index">#${rank}</div>
                    </div>
                    <div class="mobile-card-content">
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Balance:</span>
                            <span class="mobile-card-value"><strong>${balanceDisplay} TON</strong></span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Address:</span>
                            <span class="mobile-card-value mono">${makeAddressUrl(contract.address)}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Created:</span>
                            <span class="mobile-card-value">${timestampToDate(contract.created_utime)}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Last Tx:</span>
                            <span class="mobile-card-value">${timestampToDate(contract.latest_transaction_time)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        desktopHtml += `
                </tbody>
            </table>
        `;

        mobileHtml += '</div>';

        container.innerHTML = desktopHtml + mobileHtml;
    }

    // è¼‰å…¥æ•¸æ“š
    async function loadVestingData() {
        showLoading();
        try {
            console.log('é–‹å§‹ç²å– Vesting åˆç´„æ•¸æ“š...');
            updateApiStatus('Tonscan API', null);
            
            const startTime = performance.now();
            const newData = await fetchAllVestingAddresses();
            const endTime = performance.now();
            
            if (!newData || newData.length === 0) {
                throw new Error('æœªèƒ½ç²å–åˆ°ä»»ä½• Vesting åˆç´„æ•¸æ“š');
            }
            
            vestingData = newData;
            console.log(`æˆåŠŸç²å–ä¸¦è™•ç† ${vestingData.length} å€‹ Vesting åˆç´„`);
            updateApiStatus('Tonscan API', endTime - startTime);
            
            renderStats();
            filterData();
            
            // è¼‰å…¥æŒ‡ç¤ºå™¨å·²ç§»é™¤ï¼Œç„¡éœ€éš±è—
            
        } catch (error) {
            console.error('è¼‰å…¥ Vesting æ•¸æ“šå¤±æ•—:', error);
            
            // é¡¯ç¤ºæ›´å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card" style="grid-column: 1 / -1;">
                    <h3>è¼‰å…¥å¤±æ•—</h3>
                    <p class="value" style="color: #FF3B30; font-size: 16px;">
                        ${error.message || 'ç„¡æ³•è¼‰å…¥ Vesting åˆç´„æ•¸æ“š'}
                    </p>
                    <button onclick="loadVestingData()" style="margin-top: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        é‡æ–°å˜—è©¦
                    </button>
                </div>
            `;
            
            document.getElementById('tableContainer').innerHTML = '';
            // è¼‰å…¥æŒ‡ç¤ºå™¨å·²ç§»é™¤ï¼Œç„¡éœ€éš±è—
        }
    }

    // äº‹ä»¶ç›£è½å™¨

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        loadVestingData();
    });

</script>

<style>
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        min-width: 30px;
    }

    .badge-info {
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
    }

    .api-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 12px;
        z-index: 1001;
        display: none;
        width: 200px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .api-status.show {
        display: block;
        animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .api-status .api-name {
        font-weight: 600;
        color: #34C759;
    }

    .api-status .api-performance {
        font-size: 11px;
        opacity: 0.8;
        margin-top: 4px;
    }



    /* è¡¨æ ¼å®¹å™¨æ¨£å¼ - ç¬¦åˆä¸»é¡Œ */
    #tableContainer {
        overflow-x: auto;
        margin: 0;
        box-shadow: none;
        border: none;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
    }

    /* è¡¨æ ¼åŸºæœ¬æ¨£å¼ - ç¬¦åˆä¸»é¡Œ */
    table {
        width: 100%;
        min-width: 1200px;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 13px;
        background: transparent;
    }

    /* è¡¨æ ¼é ­éƒ¨æ¨£å¼ - ç¬¦åˆä¸»é¡Œ */
    thead {
        background: rgba(248, 249, 250, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* è¡¨æ ¼æ¨™é¡Œæ¨£å¼ - ç¬¦åˆä¸»é¡Œ */
    th {
        padding: 18px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: #1d1d1f;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        white-space: nowrap;
        transition: all 0.2s ease;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    th:hover {
        background: rgba(0, 122, 255, 0.05);
    }

    /* æ’åºåœ–æ¨™æ¨£å¼ - ç¬¦åˆä¸»é¡Œ */
    .sort-icon {
        margin-left: 8px;
        font-size: 12px;
        color: #8E8E93;
        transition: color 0.2s ease;
    }

    .sort-icon.active {
        color: #007AFF;
        font-weight: bold;
    }

    /* è¡¨æ ¼è³‡æ–™è¡Œæ¨£å¼ - ç¬¦åˆä¸»é¡Œ */
    td {
        padding: 16px 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        white-space: nowrap;
        font-size: 13px;
        color: #1d1d1f;
    }

    tr:hover td {
        background-color: rgba(0, 122, 255, 0.02);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ - ç¬¦åˆä¸»é¡Œ */
    @media (max-width: 768px) {
        #tableContainer {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
        }
        
        table {
            display: none;
        }
        
        .mobile-table {
            display: block;
        }
    }

    @media (min-width: 769px) {
        .mobile-table {
            display: none;
        }
    }


</style>

</body>
</html>
