<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>TON Vesting Contracts - Validators Dashboard</title>
    <link rel="stylesheet" href="assets/validators.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h1>TON Vesting Contracts</h1>
        <div class="subtitle">All Vesting contracts with sorting functionality</div>
        <div class="nav-buttons">
            <a href="index.html" class="nav-button">
                üè† Validators
            </a>
            <a href="nominators.html" class="nav-button">
                üìä Nominators
            </a>
            <a href="vesting.html" class="nav-button active">
                üí∞ Vesting
            </a>
            <a href="tontech.html" class="nav-button">
                üî¨ TON Data
            </a>
            <a href="ktonviewer.html" class="nav-button">
                üîç LST Tool
            </a>
        </div>
    </div>

    <div id="statsContainer" class="stats-grid">
    </div>



    <div id="tableContainer">
    </div>
</div>



<div class="api-status" id="apiStatus">
    <div>Data Source: <span class="api-name" id="apiName">Tonscan API</span></div>
    <div class="api-performance" id="apiPerformance"></div>
</div>

<script>
    // Utility functions
    const fromNano = (nano) => {
        return BigInt(nano) / BigInt(1e9);
    }

    const toMillions = (n) => {
        return (Number(n) / 1e6).toFixed(3) + 'M';
    }

    const toMillionsShort = (n) => {
        let s = (Number(n) / 1e6).toFixed(3);
        for (let i = 0; i < 3; i++) {
            if (s.endsWith('0')) s = s.substring(0, s.length - 1);
        }
        if (s.endsWith('.')) s = s.substring(0, s.length - 1);
        return s + 'M';
    }

    const withCommas = (n) => {
        try {
            const num = typeof n === 'bigint' ? Number(n) : Number(n);
            if (Number.isNaN(num)) return n;
            return num.toLocaleString('en-US');
        } catch {
            return n;
        }
    }

    const makeAddressUrl = (address) => {
        return `<a href="https://tonscan.org/address/${address}" target="_blank">${address}</a>`;
    }

    const showLoading = () => {
        // ËºâÂÖ•ÊåáÁ§∫Âô®Â∑≤ÁßªÈô§ÔºåÁÑ°ÈúÄÈ°ØÁ§∫
    }

    const hideLoading = () => {
        // ËºâÂÖ•ÊåáÁ§∫Âô®Â∑≤ÁßªÈô§ÔºåÁÑ°ÈúÄÈö±Ëóè
    }

    const updateProgress = (percentage, text = null) => {
        // Use API status panel to display progress
        if (text) {
            const progressText = `${Math.round(percentage)}% - ${text}`;
            updateApiStatus('Tonscan API', null, progressText, true);
            console.log(`Loading progress: ${Math.round(percentage)}% - ${text}`);
        }
    }

    const timestampToDate = (timestamp) => {
        const date = new Date(timestamp * 1000);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // Global variables
    let vestingData = [];
    let filteredData = [];
    let sortColumn = 'balance'; // Default sort by balance
    let sortDirection = 'desc'; // Default descending

    // API status updates
    function updateApiStatus(apiName, responseTime = null, progressText = null, keepVisible = false) {
        const apiStatus = document.getElementById('apiStatus');
        const apiNameElement = document.getElementById('apiName');
        const apiPerformance = document.getElementById('apiPerformance');

        apiNameElement.textContent = apiName;
        
        let performanceText = '';
        if (progressText) {
            performanceText = progressText;
        } else if (responseTime !== null) {
            performanceText = `${responseTime.toFixed(0)}ms`;
        }
        
        apiPerformance.textContent = performanceText;
        apiStatus.classList.add('show');
        
        // Clear previous timer
        if (window.apiStatusTimeout) {
            clearTimeout(window.apiStatusTimeout);
        }
        
        // Hide after 3 seconds if not keeping visible
        if (!keepVisible && !progressText) {
            window.apiStatusTimeout = setTimeout(() => {
                apiStatus.classList.remove('show');
            }, 3000);
        }
    }

    // Hide API status
    function hideApiStatus() {
        const apiStatus = document.getElementById('apiStatus');
        if (window.apiStatusTimeout) {
            clearTimeout(window.apiStatusTimeout);
        }
        apiStatus.classList.remove('show');
    }

    // Fetch all Vesting contract addresses
    async function fetchAllVestingAddresses() {
        const CODE_HASH = 'tItTGr7DtxRjgpH3137W3J9qJynvyiBHcTc3TUrotZA=';
        const BATCH_SIZE = 50;
        let allAddresses = [];
        let offset = 0;
        let hasMore = true;
        const maxEstimated = 500; // Estimated maximum count for progress calculation

        updateProgress(10, 'Fetching Vesting contract list...');

        while (hasMore && allAddresses.length < 500) {
            try {
                const url = `https://api.tonscan.com/api/bt/getAddressesForContract?code_hash=${encodeURIComponent(CODE_HASH)}&limit=${BATCH_SIZE}&offset=${offset}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check API response structure
                if (!data.json || !data.json.data) {
                    console.warn('Unusual API response format:', data);
                    hasMore = false;
                    break;
                }
                
                const addresses = data.json.data;
                
                if (!Array.isArray(addresses) || addresses.length === 0) {
                    console.log(`No more data at offset ${offset}, ending fetch`);
                    hasMore = false;
                } else {
                    allAddresses = allAddresses.concat(addresses);
                    offset += BATCH_SIZE;
                    
                    // Update progress (10% - 70%)
                    const fetchProgress = Math.min(70, 10 + (allAddresses.length / maxEstimated) * 60);
                    updateProgress(fetchProgress, `Fetched ${allAddresses.length} Vesting contract addresses...`);
                    
                    console.log(`Fetched ${allAddresses.length} Vesting contract addresses...`);
                }
                
                // Avoid too frequent requests
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error(`Failed to fetch address list (offset: ${offset}):`, error);
                hasMore = false;
                break;
            }
        }

        updateProgress(80, 'Processing and sorting data...');
        console.log(`Total fetched ${allAddresses.length} Vesting contract addresses`);

        // Filter invalid data and sort by balance
        const validAddresses = allAddresses.filter(addr => 
            addr && addr.address && typeof addr.balance !== 'undefined'
        );
        
        updateProgress(90, 'Sorting contracts...');
        
        validAddresses.sort((a, b) => {
            try {
                return BigInt(b.balance) - BigInt(a.balance) > 0 ? 1 : -1;
            } catch (e) {
                console.warn('Invalid balance encountered during sorting:', a.balance, b.balance);
                return 0;
            }
        });
        
        updateProgress(100, 'Loading complete!');
        
        return validAddresses; // Return all addresses, no limit
    }

    // Render statistics
    function renderStats() {
        if (!vestingData || vestingData.length === 0) {
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <h3>Loading...</h3>
                    <p class="value">-</p>
                </div>
            `;
            return;
        }

        const totalContracts = vestingData.length;
        const totalBalance = vestingData.reduce((sum, contract) => {
            try {
                return sum + BigInt(contract.balance || 0);
            } catch (e) {
                console.warn('Invalid balance data:', contract.balance);
                return sum;
            }
        }, BigInt(0));
        
        const activeContracts = vestingData.filter(c => c.balance && Number(c.balance) > 0).length;
        const averageBalance = totalContracts > 0 ? totalBalance / BigInt(totalContracts) : BigInt(0);

        const oldestContract = vestingData.reduce((oldest, contract) => {
            if (!contract.created_utime) return oldest;
            if (!oldest.created_utime) return contract;
            return contract.created_utime < oldest.created_utime ? contract : oldest;
        }, {created_utime: Date.now() / 1000});

        document.getElementById('statsContainer').innerHTML = `
            <div class="stat-card">
                <h3>Total Contracts</h3>
                <p class="value">${withCommas(totalContracts)}</p>
            </div>
            <div class="stat-card">
                <h3>Active Contracts</h3>
                <p class="value">${withCommas(activeContracts)}</p>
            </div>
            <div class="stat-card">
                <h3>Total Balance</h3>
                <p class="value">${toMillionsShort(fromNano(totalBalance))} TON</p>
            </div>
            <div class="stat-card">
                <h3>Average Balance</h3>
                <p class="value">${toMillionsShort(fromNano(averageBalance))} TON</p>
            </div>
            <div class="stat-card">
                <h3>Oldest Contract</h3>
                <p class="value">${oldestContract.created_utime ? new Date(oldestContract.created_utime * 1000).toLocaleDateString() : 'N/A'}</p>
            </div>
        `;
    }

    // Sort function
    function sortData(column) {
        if (sortColumn === column) {
            // If clicking the same column, toggle sort direction
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // If clicking different column, set new column and use default sort direction
            sortColumn = column;
            sortDirection = column === 'balance' ? 'desc' : 'asc';
        }
        
        filterData();
    }

    // Sort data
    function filterData() {
        let filtered = [...vestingData]; // Copy all data

        // Sort logic
        filtered.sort((a, b) => {
            let valueA, valueB;
            
            switch (sortColumn) {
                case 'rank':
                    valueA = vestingData.indexOf(a) + 1;
                    valueB = vestingData.indexOf(b) + 1;
                    break;
                case 'address':
                    valueA = a.address.toLowerCase();
                    valueB = b.address.toLowerCase();
                    break;
                case 'balance':
                    valueA = BigInt(a.balance || 0);
                    valueB = BigInt(b.balance || 0);
                    break;
                case 'created':
                    valueA = a.created_utime || 0;
                    valueB = b.created_utime || 0;
                    break;
                case 'lastTx':
                    valueA = a.latest_transaction_time || 0;
                    valueB = b.latest_transaction_time || 0;
                    break;
                default:
                    return 0;
            }
            
            if (sortColumn === 'balance') {
                // BigInt comparison
                const result = valueA - valueB;
                return sortDirection === 'asc' ? 
                    (result > 0 ? 1 : result < 0 ? -1 : 0) : 
                    (result > 0 ? -1 : result < 0 ? 1 : 0);
            } else {
                // General comparison
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            }
        });

        filteredData = filtered;
        renderTable();
    }

    // Get sort icon
    function getSortIcon(column) {
        if (sortColumn !== column) {
            return '<span class="sort-icon">‚ÜïÔ∏è</span>';
        }
        return sortDirection === 'asc' ? 
            '<span class="sort-icon active">‚Üë</span>' : 
            '<span class="sort-icon active">‚Üì</span>';
    }

    // Render table
    function renderTable() {
        const container = document.getElementById('tableContainer');
        
        // Desktop table
        let desktopHtml = `
            <table>
                <thead>
                    <tr>
                        <th onclick="sortData('rank')">
                            Rank ${getSortIcon('rank')}
                        </th>
                        <th onclick="sortData('address')">
                            Address ${getSortIcon('address')}
                        </th>
                        <th onclick="sortData('balance')">
                            Balance (TON) ${getSortIcon('balance')}
                        </th>
                        <th onclick="sortData('created')">
                            Created ${getSortIcon('created')}
                        </th>
                        <th onclick="sortData('lastTx')">
                            Last Transaction ${getSortIcon('lastTx')}
                        </th>
                    </tr>
                </thead>
                <tbody>
        `;

        // Mobile cards
        let mobileHtml = '<div class="mobile-table">';

        filteredData.forEach((contract, index) => {
            const balance = fromNano(contract.balance);
            const balanceDisplay = Number(balance) === 0 ? '0' : toMillions(balance);
            const rank = vestingData.indexOf(contract) + 1;
            
            // Desktop table row
            desktopHtml += `
                <tr>
                    <td><span class="badge badge-info">#${rank}</span></td>
                    <td class="mono">${makeAddressUrl(contract.address)}</td>
                    <td><strong>${balanceDisplay} TON</strong></td>
                    <td>${timestampToDate(contract.created_utime)}</td>
                    <td>${timestampToDate(contract.latest_transaction_time)}</td>
                </tr>
            `;

            // Mobile card
            mobileHtml += `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <div class="mobile-card-title">
                            Vesting Contract #${rank}
                        </div>
                        <div class="mobile-card-index">#${rank}</div>
                    </div>
                    <div class="mobile-card-content">
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Balance:</span>
                            <span class="mobile-card-value"><strong>${balanceDisplay} TON</strong></span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Address:</span>
                            <span class="mobile-card-value mono">${makeAddressUrl(contract.address)}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Created:</span>
                            <span class="mobile-card-value">${timestampToDate(contract.created_utime)}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Last Tx:</span>
                            <span class="mobile-card-value">${timestampToDate(contract.latest_transaction_time)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        desktopHtml += `
                </tbody>
            </table>
        `;

        mobileHtml += '</div>';

        container.innerHTML = desktopHtml + mobileHtml;
    }

    // Load data
    async function loadVestingData() {
        showLoading();
        try {
            console.log('Starting to fetch Vesting contract data...');
            // Show initial progress at start
            updateProgress(0, 'Starting to load Vesting contract data...');
            
            const startTime = performance.now();
            const newData = await fetchAllVestingAddresses();
            const endTime = performance.now();
            
            if (!newData || newData.length === 0) {
                throw new Error('Unable to fetch any Vesting contract data');
            }
            
            vestingData = newData;
            console.log(`Successfully fetched and processed ${vestingData.length} Vesting contracts`);
            
            // Show result after completion and hide after 3 seconds
            const completionText = `Complete! Loaded ${vestingData.length} contracts (${(endTime - startTime).toFixed(0)}ms)`;
            updateApiStatus('Tonscan API', endTime - startTime, completionText, false);
            
            renderStats();
            filterData();
            
            // Hide API status after 3 seconds
            setTimeout(() => {
                hideApiStatus();
            }, 3000);
            
        } catch (error) {
            console.error('Loading Vesting data failed:', error);
            
            // Show error status
            updateApiStatus('Loading Failed', null, error.message || 'Unable to load data', false);
            
            // Show friendly error message
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card" style="grid-column: 1 / -1;">
                    <h3>Loading Failed</h3>
                    <p class="value" style="color: #FF3B30; font-size: 16px;">
                        ${error.message || 'Unable to load Vesting contract data'}
                    </p>
                    <button onclick="loadVestingData()" style="margin-top: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
            
            document.getElementById('tableContainer').innerHTML = '';
            
            // Error status displayed for 5 seconds
            setTimeout(() => {
                hideApiStatus();
            }, 5000);
        }
    }

    // Event listeners

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        loadVestingData();
    });

</script>

<style>
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        min-width: 30px;
    }

    .badge-info {
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
    }

    .api-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 12px;
        z-index: 1001;
        display: none;
        min-width: 250px;
        max-width: 350px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .api-status.show {
        display: block;
        animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .api-status .api-name {
        font-weight: 600;
        color: #34C759;
    }

    .api-status .api-performance {
        font-size: 11px;
        opacity: 0.9;
        margin-top: 4px;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.4;
    }



    /* Table container styles - theme compliant */
    #tableContainer {
        overflow-x: auto;
        margin: 0;
        box-shadow: none;
        border: none;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
    }

    /* Basic table styles - theme compliant */
    table {
        width: 100%;
        min-width: 1200px;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 13px;
        background: transparent;
    }

    /* Table header styles - theme compliant */
    thead {
        background: rgba(248, 249, 250, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Table title styles - theme compliant */
    th {
        padding: 18px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: #1d1d1f;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        white-space: nowrap;
        transition: all 0.2s ease;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    th:hover {
        background: rgba(0, 122, 255, 0.05);
    }

    /* Sort icon styles - theme compliant */
    .sort-icon {
        margin-left: 8px;
        font-size: 12px;
        color: #8E8E93;
        transition: color 0.2s ease;
    }

    .sort-icon.active {
        color: #007AFF;
        font-weight: bold;
    }

    /* Table data row styles - theme compliant */
    td {
        padding: 16px 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        white-space: nowrap;
        font-size: 13px;
        color: #1d1d1f;
    }

    tr:hover td {
        background-color: rgba(0, 122, 255, 0.02);
    }

    /* Responsive design - theme compliant */
    @media (max-width: 768px) {
        #tableContainer {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
        }
        
        table {
            display: none;
        }
        
        .mobile-table {
            display: block;
        }
    }

    @media (min-width: 769px) {
        .mobile-table {
            display: none;
        }
    }


</style>

</body>
</html>
